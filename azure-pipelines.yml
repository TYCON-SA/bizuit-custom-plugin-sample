trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - plugin.json
      - package.json

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  dotnetVersion: '9.0.x'
  nodeVersion: '20.x'

stages:
  - stage: Build
    displayName: 'Build Plugin Package'
    jobs:
      - job: BuildPlugin
        displayName: 'Build and Package Plugin'
        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true

          - task: UseDotNet@2
            displayName: 'Setup .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: npm install
            displayName: 'Install npm dependencies'

          - script: |
              COMMIT_HASH="$(Build.SourceVersion)"
              SHORT_HASH="${COMMIT_HASH:0:7}"
              BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

              echo "##vso[task.setvariable variable=commitHash]$COMMIT_HASH"
              echo "##vso[task.setvariable variable=shortHash]$SHORT_HASH"
              echo "##vso[task.setvariable variable=buildDate]$BUILD_DATE"

              echo "Commit: $SHORT_HASH"
              echo "Build Date: $BUILD_DATE"
            displayName: 'Get build metadata'

          - script: |
              # Pull latest changes to get version commits (they have [skip ci] so won't be in checkout)
              git pull origin main --rebase || true

              # Read current version from plugin.json (this is the source of truth)
              CURRENT_VERSION=$(jq -r '.version' plugin.json)
              echo "Current version in plugin.json: $CURRENT_VERSION"

              # Validate current version format
              if [ -z "$CURRENT_VERSION" ] || ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                NEW_VERSION="1.0.0"
                echo "Invalid or missing version! Starting at v1.0.0"
              else
                # Increment PATCH from current version
                IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
                PATCH=$((PATCH + 1))
                NEW_VERSION="$MAJOR.$MINOR.$PATCH"
                echo "Auto-increment: $CURRENT_VERSION -> $NEW_VERSION"
              fi

              echo "##vso[task.setvariable variable=pluginVersion]$NEW_VERSION"

              # Update plugin.json with new version
              jq --arg version "$NEW_VERSION" '.version = $version' plugin.json > plugin.tmp.json
              mv plugin.tmp.json plugin.json

              echo "Updated plugin.json to version $NEW_VERSION"
            displayName: 'Calculate version'

          - script: |
              PLUGIN_NAME=$(jq -r '.name' plugin.json)
              PLUGIN_DESC=$(jq -r '.description // "Backend plugin"' plugin.json)
              PLUGIN_AUTHOR=$(jq -r '.author // "BIZUIT"' plugin.json)

              # Derive project name from entryPoint (e.g., "MyPlugin.dll" -> "MyPlugin")
              ENTRY_POINT=$(jq -r '.entryPoint' plugin.json)
              PROJECT_NAME="${ENTRY_POINT%.dll}"

              echo "##vso[task.setvariable variable=pluginName]$PLUGIN_NAME"
              echo "##vso[task.setvariable variable=pluginDesc]$PLUGIN_DESC"
              echo "##vso[task.setvariable variable=pluginAuthor]$PLUGIN_AUTHOR"
              echo "##vso[task.setvariable variable=projectName]$PROJECT_NAME"

              echo "Plugin: $PLUGIN_NAME"
              echo "Project: $PROJECT_NAME"
              echo "Description: $PLUGIN_DESC"
            displayName: 'Read plugin metadata'

          - script: |
              echo "Building plugin..."
              dotnet publish src/$(projectName)/$(projectName).csproj -c Release -o publish

              echo "Build completed"
              ls -la publish/
            displayName: 'Build and publish plugin'

          - script: |
              PLUGIN_NAME="$(pluginName)"
              VERSION="$(pluginVersion)"
              SHORT_HASH="$(shortHash)"
              COMMIT_HASH="$(commitHash)"
              BUILD_DATE="$(buildDate)"

              ZIP_NAME="${PLUGIN_NAME}.${VERSION}-${SHORT_HASH}.zip"

              mkdir -p dist

              # Get release notes from git commit message
              RELEASE_NOTES=$(git log -1 --pretty=%B)

              # Get repository URL from git remote
              REPO_URL=$(git remote get-url origin 2>/dev/null | sed 's/\.git$//' || echo "")

              # Build URL for Azure DevOps
              BUILD_URL="$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"

              echo "Adding metadata to plugin.json:"
              echo "  - commitHash: $SHORT_HASH"
              echo "  - buildDate: $BUILD_DATE"
              echo "  - buildUrl: $BUILD_URL"
              echo "  - repositoryUrl: $REPO_URL"

              # Enrich plugin.json with all metadata
              jq --arg commitHash "$COMMIT_HASH" \
                 --arg buildDate "$BUILD_DATE" \
                 --arg releaseNotes "$RELEASE_NOTES" \
                 --arg repositoryUrl "$REPO_URL" \
                 --arg buildUrl "$BUILD_URL" \
                 '. + {commitHash: $commitHash, buildDate: $buildDate, releaseNotes: $releaseNotes, repositoryUrl: $repositoryUrl, buildUrl: $buildUrl}' \
                 plugin.json > plugin.enriched.json

              # Create ZIP with published files + enriched plugin.json
              cd publish
              cp ../plugin.enriched.json ./plugin.json
              zip -r "../dist/${ZIP_NAME}" .
              cd ..

              echo "##vso[task.setvariable variable=zipName]$ZIP_NAME"

              echo "Created: dist/${ZIP_NAME}"
              ls -la dist/
            displayName: 'Create ZIP package with metadata'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish artifact'
            inputs:
              targetPath: 'dist'
              artifact: '$(pluginName)-$(pluginVersion)'
              publishLocation: 'pipeline'

          - script: |
              echo "ðŸ“ Committing version update..."

              git config user.name "Azure Pipelines"
              git config user.email "azure-pipelines@dev.azure.com"

              git add plugin.json

              if git diff --staged --quiet; then
                echo "âš ï¸ No version changes to commit"
              else
                git commit -m "chore: bump version to $(pluginVersion) [skip ci]"

                echo "ðŸ“¤ Pushing changes to repository..."

                # Extract branch name from refs/heads/main -> main
                BRANCH_NAME=$(echo "$(Build.SourceBranch)" | sed 's|refs/heads/||')
                echo "Branch: $BRANCH_NAME"

                # Push with explicit error handling
                if git push origin HEAD:$BRANCH_NAME; then
                  echo "âœ… Version update committed and pushed successfully"
                else
                  echo "âŒ Failed to push changes"
                  echo "This might be a permissions issue. Check pipeline settings:"
                  echo "  - Project Settings â†’ Repositories â†’ Security"
                  echo "  - Grant 'Contribute' permission to Build Service"
                  exit 1
                fi
              fi
            displayName: 'Commit version update'
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

          - script: |
              echo "=============================================="
              echo "  Plugin Package Created Successfully!"
              echo "=============================================="
              echo ""
              echo "Plugin: $(pluginName)"
              echo "Version: $(pluginVersion)"
              echo "Commit: $(shortHash)"
              echo "Build Date: $(buildDate)"
              echo ""
              echo "Artifact: $(zipName)"
              echo ""
              echo "Metadata included:"
              echo "  - commitHash: $(shortHash)"
              echo "  - buildDate: $(buildDate)"
              echo "  - releaseNotes: (from commit message)"
              echo "  - buildUrl: (Azure DevOps build link)"
              echo "  - repositoryUrl: (from git remote)"
              echo ""
              echo "Installation:"
              echo "  1. Download artifact from this pipeline"
              echo "  2. Go to Admin Panel > Plugins > Upload Plugin"
              echo "  3. Upload the ZIP file"
              echo "  4. Configure connection string if needed"
              echo "  5. Activate the plugin"
              echo ""
              echo "API Endpoints will be available at:"
              echo "  /api/plugins/$(pluginName)/*"
              echo "=============================================="
            displayName: 'Summary'
